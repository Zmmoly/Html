<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ø¬Ø§Ù…Ø¹ ØªÙ„Ø§ÙˆØ§Øª Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…</title>
  <style>
    /* â”€â”€ Reset & Variables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --green:      #1a7f4b;
      --green-dark: #115c35;
      --green-light:#e8f5ee;
      --gold:       #c9a84c;
      --red:        #c0392b;
      --bg:         #f7f3ec;
      --card:       #ffffff;
      --text:       #1a1a2e;
      --muted:      #6b7280;
      --radius:     16px;
      --shadow:     0 8px 32px rgba(0,0,0,.10);
    }

    body {
      font-family: "Segoe UI", system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 24px 16px 48px;
    }

    /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    header {
      text-align: center;
      margin-bottom: 32px;
    }
    header h1 {
      font-size: clamp(1.4rem, 4vw, 2rem);
      color: var(--green-dark);
      font-weight: 800;
    }
    header p {
      color: var(--muted);
      font-size: .9rem;
      margin-top: 6px;
    }
    .ornament {
      color: var(--gold);
      font-size: 1.6rem;
      letter-spacing: 4px;
    }

    /* â”€â”€ Goal Progress â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #goal-wrap {
      background: var(--card);
      border: 1px solid #e5e7eb;
      border-radius: 16px;
      padding: 16px 24px;
      margin-bottom: 24px;
      text-align: center;
    }
    .goal-label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: .85rem;
      color: var(--muted);
      margin-bottom: 10px;
    }
    #goal-pct {
      font-size: 1.4rem;
      font-weight: 800;
      color: var(--green);
    }
    .goal-bar-bg {
      height: 14px;
      background: #e5e7eb;
      border-radius: 999px;
      overflow: hidden;
      margin-bottom: 8px;
    }
    .goal-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--green), var(--gold));
      border-radius: 999px;
      transition: width 1s ease;
    }


    /* â”€â”€ Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .card {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 32px;
      width: 100%;
      max-width: 680px;
    }

    /* â”€â”€ Ayah Display â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #ayah-meta {
      font-size: .78rem;
      color: var(--muted);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .mode-badge {
      background: var(--green-light);
      color: var(--green-dark);
      border-radius: 999px;
      padding: 2px 10px;
      font-size: .75rem;
      font-weight: 600;
    }

    #ayah-text {
      font-family: "KFGQPC Uthman Taha Naskh", "Amiri Quran", "Scheherazade New", serif;
      font-size: clamp(1.5rem, 4.5vw, 2.2rem);
      line-height: 2.2;
      color: var(--text);
      text-align: center;
      letter-spacing: .5px;
      min-height: 100px;
      border: 2px dashed #e5e7eb;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 24px;
      background: var(--green-light);
      transition: border-color .3s;
    }
    #ayah-text.loading {
      color: var(--muted);
      font-size: 1rem;
      font-family: inherit;
    }

    /* â”€â”€ Waveform â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    canvas#waveform {
      width: 100%;
      height: 72px;
      border-radius: 10px;
      background: #111827;
      margin-bottom: 20px;
      display: block;
    }

    /* â”€â”€ Timer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #timer {
      text-align: center;
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--red);
      letter-spacing: 2px;
      margin-bottom: 16px;
      min-height: 28px;
    }

    /* â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .btn-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: center;
    }
    button {
      border: none;
      border-radius: 12px;
      padding: 13px 28px;
      font-size: .95rem;
      font-weight: 700;
      cursor: pointer;
      transition: transform .1s, opacity .2s, background .2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    button:active { transform: scale(.97); }
    button:disabled { opacity: .45; cursor: not-allowed; }

    #btn-record  { background: var(--green);     color: #fff; }
    #btn-record.recording { background: var(--red); }
    #btn-submit  { background: var(--gold);       color: #fff; }
    #btn-skip    { background: #f3f4f6;           color: var(--text); }
    #btn-play    { background: #3b82f6;           color: #fff; }

    /* â”€â”€ Status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #status {
      text-align: center;
      margin-top: 18px;
      font-size: .88rem;
      min-height: 22px;
      color: var(--muted);
    }
    #status.success { color: var(--green);   }
    #status.error   { color: var(--red);     }
    #status.info    { color: #2563eb;        }

    /* â”€â”€ Progress â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .progress-wrap {
      margin-top: 24px;
    }
    .progress-label {
      display: flex;
      justify-content: space-between;
      font-size: .8rem;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .progress-bar-bg {
      height: 8px;
      background: #e5e7eb;
      border-radius: 999px;
      overflow: hidden;
    }
    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--green), var(--gold));
      border-radius: 999px;
      transition: width .5s ease;
    }

    /* â”€â”€ Celebration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #celebration {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
      animation: fadeIn .3s ease;
    }
    #celebration-content {
      background: #fff;
      border-radius: 24px;
      padding: 40px 32px;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      animation: popIn .4s cubic-bezier(0.175,0.885,0.32,1.275);
    }
    #celebration-emoji {
      font-size: 4rem;
      margin-bottom: 12px;
      animation: bounce 0.6s infinite alternate;
    }
    #celebration-msg {
      font-size: 1.6rem;
      font-weight: 800;
      color: var(--green);
      margin-bottom: 8px;
    }
    #celebration-sub {
      font-size: .9rem;
      color: var(--muted);
    }
    #confetti-canvas {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 998;
    }
    @keyframes fadeIn  { from { opacity:0 } to { opacity:1 } }
    @keyframes popIn   { from { transform:scale(0.5); opacity:0 } to { transform:scale(1); opacity:1 } }
    @keyframes bounce  { from { transform:translateY(0) } to { transform:translateY(-10px) } }

    /* â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(80px);
      background: #1f2937;
      color: #fff;
      padding: 12px 24px;
      border-radius: 12px;
      font-size: .9rem;
      opacity: 0;
      transition: all .4s ease;
      pointer-events: none;
      z-index: 999;
      max-width: 90vw;
      text-align: center;
    }
    #toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    /* â”€â”€ RTL helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .ltr { direction: ltr; }
  </style>

  <!-- Google Fonts for Quranic text -->
  <link href="https://fonts.googleapis.com/css2?family=Amiri+Quran&family=Scheherazade+New:wght@400;700&display=swap" rel="stylesheet" />
</head>
<body>

<header>
  <div class="ornament">ï´¾ ï´¿</div>
  <h1>Ø¬Ø§Ù…Ø¹ Ø§Ù„ØªÙ„Ø§ÙˆØ§Øª Ø§Ù„Ù‚Ø±Ø¢Ù†ÙŠØ©</h1>
  <p>Ø³Ø¬Ù‘Ù„ ØµÙˆØªÙƒ Ù„Ø¨Ù†Ø§Ø¡ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØªÙ„Ø§ÙˆØ©</p>
</header>

<!-- Goal Progress -->
<div id="goal-wrap">
  <div class="goal-label">
    <span id="goal-pct">0%</span>
  </div>
  <div class="goal-bar-bg">
    <div class="goal-bar-fill" id="goal-fill" style="width:0%"></div>
  </div>
</div>

<!-- Main card -->
<div class="card">

  <div id="ayah-meta">
    <span class="mode-badge" id="mode-badge">â€”</span>
    <span id="ayah-ref" class="ltr">â€”</span>
  </div>

  <div id="ayah-text" class="loading">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Øµâ€¦</div>

  <canvas id="waveform"></canvas>
  <div id="timer"></div>

  <div class="btn-row">
    <button id="btn-record" disabled>ğŸ™ Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
    <button id="btn-play"   disabled>â–¶ Ø§Ø³ØªÙ…Ø§Ø¹</button>
    <button id="btn-submit" disabled>ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„</button>
    <button id="btn-skip">â­ ØªØ®Ø·Ù‘ÙŠ</button>
  </div>

  <div id="status">â€”</div>



</div>

<div id="toast"></div>
<div id="celebration" style="display:none">
  <div id="celebration-content">
    <div id="celebration-emoji">ğŸ‰</div>
    <div id="celebration-msg">Ø¬Ø²Ø§Ùƒ Ø§Ù„Ù„Ù‡ Ø®ÙŠØ±Ø§Ù‹!</div>
    <div id="celebration-sub">ØªØ³Ø¬ÙŠÙ„Ùƒ Ø³ÙŠØ³Ø§Ù‡Ù… ÙÙŠ Ø®Ø¯Ù…Ø© Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…</div>
  </div>
</div>
<canvas id="confetti-canvas"></canvas>

<script>
// â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const BACKEND = "https://quran-collector.zmmoly.workers.dev"; // â† change this

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentTask   = null;
let mediaRecorder = null;
let audioChunks   = [];
let audioBlob     = null;
let audioURL      = null;
let timerInterval = null;
let elapsed       = 0;
let audioCtx      = null;
let analyserNode  = null;
let animFrame     = null;

// â”€â”€ DOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const elText    = document.getElementById("ayah-text");
const elMeta    = document.getElementById("ayah-ref");
const elMode    = document.getElementById("mode-badge");
const elStatus  = document.getElementById("status");
const elTimer   = document.getElementById("timer");
const canvas    = document.getElementById("waveform");
const ctx2d     = canvas.getContext("2d");
const btnRecord = document.getElementById("btn-record");
const btnPlay   = document.getElementById("btn-play");
const btnSubmit = document.getElementById("btn-submit");
const btnSkip   = document.getElementById("btn-skip");



// â”€â”€ Mode labels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MODE_LABELS = {
  "full_verse":    "Ø¢ÙŠØ© ÙƒØ§Ù…Ù„Ø©",
  "bridging":      "ÙˆØµÙ„ Ø¢ÙŠØªÙŠÙ†",
  "random_window": "Ù…Ù‚Ø·Ø¹ Ø¹Ø´ÙˆØ§Ø¦ÙŠ",
};

// â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showToast(msg, duration = 3000) {
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(() => t.classList.remove("show"), duration);
}

// â”€â”€ Status helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setStatus(msg, type = "") {
  elStatus.textContent = msg;
  elStatus.className   = type;
}

// â”€â”€ Fetch task â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchTask() {
  elText.textContent = "Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Øµâ€¦";
  elText.className   = "loading";
  setStatus("Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ù…Ù‚Ø·Ø¹ Ø¬Ø¯ÙŠØ¯â€¦", "info");
  resetRecorder();

  try {
    const res  = await fetch(`${BACKEND}/get_task`);
    if (!res.ok) throw new Error(await res.text());
    currentTask = await res.json();

    elText.textContent = currentTask.text;
    elText.className   = "";
    elMode.textContent = MODE_LABELS[currentTask.mode] || currentTask.mode;
    elMeta.textContent = `Ø³ÙˆØ±Ø© ${currentTask.surah} : Ø¢ÙŠØ© ${currentTask.ayah}`;
    btnRecord.disabled = false;
    setStatus("Ø§Ø¶ØºØ· Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆØ§Ù‚Ø±Ø£ Ø§Ù„Ù†Øµ Ø¨ÙˆØ¶ÙˆØ­", "");
  } catch (e) {
    setStatus("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø©: " + e.message, "error");
  }
}

// â”€â”€ Fetch stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const GOAL = 1_000_000;
async function fetchStats() {
  try {
    const res  = await fetch(`${BACKEND}/stats`);
    const data = await res.json();
    const done = data.total_recordings ?? 0;
    const pct  = Math.min((done / GOAL) * 100, 100);
    const pctStr = pct < 0.01 ? "<0.01" : pct.toFixed(2);
    document.getElementById("goal-fill").style.width = pct + "%";
    document.getElementById("goal-pct").textContent  = pctStr + "%";
    document.getElementById("goal-done").textContent = done.toLocaleString("ar-EG");
  } catch (_) {}
}

// â”€â”€ Reset recorder state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function resetRecorder() {
  btnRecord.textContent = "ğŸ™ Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„";
  btnRecord.classList.remove("recording");
  if (mediaRecorder && mediaRecorder.state !== "inactive") mediaRecorder.stop();
  clearInterval(timerInterval);
  cancelAnimationFrame(animFrame);

  audioChunks = [];
  audioBlob   = null;
  if (audioURL) { URL.revokeObjectURL(audioURL); audioURL = null; }
  elapsed     = 0;
  elTimer.textContent = "";

  btnRecord.disabled = true;
  btnStop.disabled   = true;
  btnPlay.disabled   = true;
  btnSubmit.disabled = true;

  // Clear waveform
  ctx2d.clearRect(0, 0, canvas.width, canvas.height);
}

// â”€â”€ Timer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startTimer() {
  elapsed = 0;
  clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    elapsed++;
    const m = String(Math.floor(elapsed / 60)).padStart(2, "0");
    const s = String(elapsed % 60).padStart(2, "0");
    elTimer.textContent = `${m}:${s}`;
  }, 1000);
}

// â”€â”€ Waveform visualiser â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startVisualiser(stream) {
  audioCtx     = new (window.AudioContext || window.webkitAudioContext)();
  analyserNode = audioCtx.createAnalyser();
  analyserNode.fftSize = 1024;
  const src = audioCtx.createMediaStreamSource(stream);
  src.connect(analyserNode);

  const bufLen = analyserNode.frequencyBinCount;
  const dataArr = new Uint8Array(bufLen);

  function draw() {
    animFrame = requestAnimationFrame(draw);
    analyserNode.getByteTimeDomainData(dataArr);

    const W = canvas.offsetWidth;
    const H = canvas.height;
    canvas.width = W;

    ctx2d.fillStyle = "#111827";
    ctx2d.fillRect(0, 0, W, H);

    ctx2d.lineWidth   = 2;
    ctx2d.strokeStyle = "#22c55e";
    ctx2d.beginPath();

    const sliceW = W / bufLen;
    let x = 0;
    for (let i = 0; i < bufLen; i++) {
      const v = dataArr[i] / 128;
      const y = (v * H) / 2;
      i === 0 ? ctx2d.moveTo(x, y) : ctx2d.lineTo(x, y);
      x += sliceW;
    }
    ctx2d.lineTo(W, H / 2);
    ctx2d.stroke();
  }
  draw();
}

// â”€â”€ Record â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
btnRecord.addEventListener("click", async () => {
  // If currently recording, stop
  if (btnRecord.classList.contains("recording")) {
    if (mediaRecorder && mediaRecorder.state !== "inactive") mediaRecorder.stop();
    return;
  }
  if (!navigator.mediaDevices?.getUserMedia) {
    setStatus("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØªÙŠ", "error");
    return;
  }

  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      audio: {
        sampleRate:   16000,
        channelCount: 1,
        echoCancellation: true,
        noiseSuppression: true,
      }
    });

    // Prefer WAV; fall back to webm then ogg
    const mimeType =
      MediaRecorder.isTypeSupported("audio/wav")        ? "audio/wav"        :
      MediaRecorder.isTypeSupported("audio/webm;codecs=pcm") ? "audio/webm;codecs=pcm" :
      MediaRecorder.isTypeSupported("audio/webm")       ? "audio/webm"       :
      "audio/ogg;codecs=opus";

    mediaRecorder = new MediaRecorder(stream, { mimeType, audioBitsPerSecond: 256000 });
    audioChunks   = [];

    mediaRecorder.ondataavailable = e => { if (e.data.size > 0) audioChunks.push(e.data); };
    mediaRecorder.onstop = () => {
      btnRecord.textContent = "ğŸ™ Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„";
      btnRecord.classList.remove("recording");
      stream.getTracks().forEach(t => t.stop());
      audioBlob = new Blob(audioChunks, { type: "audio/wav" });
      audioURL  = URL.createObjectURL(audioBlob);
      btnPlay.disabled   = false;
      btnSubmit.disabled = false;
      cancelAnimationFrame(animFrame);
      clearInterval(timerInterval);
      setStatus("âœ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¥Ø±Ø³Ø§Ù„", "success");
    };

    mediaRecorder.start(100);
    startTimer();
    startVisualiser(stream);

    btnRecord.textContent = "â¹ Ø¥ÙŠÙ‚Ø§Ù";
    btnRecord.classList.add("recording");
    btnSubmit.disabled = true;
    setStatus("ğŸ”´ Ø¬Ø§Ø±Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„â€¦", "error");

  } catch (e) {
    setStatus("Ù„Ù… ÙŠÙÙ…Ù†Ø­ Ø¥Ø°Ù† Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†: " + e.message, "error");
  }
});

// â”€â”€ Stop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
btnStop.addEventListener("click", () => {
  if (mediaRecorder && mediaRecorder.state !== "inactive") mediaRecorder.stop();
  });

// â”€â”€ Play â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
btnPlay.addEventListener("click", () => {
  if (audioURL) new Audio(audioURL).play();
});

// â”€â”€ Submit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
btnSubmit.addEventListener("click", async () => {
  if (!audioBlob || !currentTask) return;

  btnSubmit.disabled = true;
  btnSkip.disabled   = true;
  setStatus("Ø¬Ø§Ø±Ù Ø§Ù„Ø±ÙØ¹â€¦", "info");

  const form = new FormData();
  form.append("task_id",    currentTask.task_id);
  form.append("transcript", currentTask.text);
  form.append("audio",      audioBlob, `${currentTask.task_id}.wav`);

  try {
    const res  = await fetch(`${BACKEND}/submit`, { method: "POST", body: form });
    if (!res.ok) throw new Error(await res.text());
    const data = await res.json();

    showCelebration();
    setStatus("", "");
    await fetchStats();
    setTimeout(fetchTask, 2500);
  } catch (e) {
    setStatus("ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹: " + e.message, "error");
    btnSubmit.disabled = false;
  }

  btnSkip.disabled = false;
});

// â”€â”€ Celebration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showCelebration() {
  const el = document.getElementById("celebration");
  el.style.display = "flex";
  launchConfetti();
  setTimeout(() => {
    el.style.display = "none";
    stopConfetti();
  }, 2400);
}

// Confetti
let confettiAnim = null;
const COLORS = ["#22c55e","#f59e0b","#3b82f6","#ec4899","#8b5cf6","#ef4444"];
let particles = [];

function launchConfetti() {
  const canvas = document.getElementById("confetti-canvas");
  canvas.width  = window.innerWidth;
  canvas.height = window.innerHeight;
  const ctx = canvas.getContext("2d");
  particles = Array.from({length: 120}, () => ({
    x: Math.random() * canvas.width,
    y: Math.random() * -canvas.height,
    w: 8 + Math.random() * 8,
    h: 4 + Math.random() * 4,
    color: COLORS[Math.floor(Math.random() * COLORS.length)],
    speed: 3 + Math.random() * 5,
    angle: Math.random() * 360,
    spin: (Math.random() - 0.5) * 6,
    drift: (Math.random() - 0.5) * 2,
  }));

  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    particles.forEach(p => {
      ctx.save();
      ctx.translate(p.x + p.w/2, p.y + p.h/2);
      ctx.rotate(p.angle * Math.PI / 180);
      ctx.fillStyle = p.color;
      ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
      ctx.restore();
      p.y     += p.speed;
      p.x     += p.drift;
      p.angle += p.spin;
    });
    confettiAnim = requestAnimationFrame(draw);
  }
  draw();
}

function stopConfetti() {
  if (confettiAnim) cancelAnimationFrame(confettiAnim);
  const canvas = document.getElementById("confetti-canvas");
  canvas.getContext("2d").clearRect(0, 0, canvas.width, canvas.height);
}

// â”€â”€ Skip â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
btnSkip.addEventListener("click", fetchTask);

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(async () => {
  await fetchTask();
  await fetchStats();
  setInterval(fetchStats, 30000);
})();
</script>
</body>
</html>
